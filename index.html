<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O.N.G. Colectivo Social Nacional ‚Äì Sistema de Censo Territorial</title>
    <style>
        /* ===== ESTILOS GENERALES ===== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #333;
            min-height: 100vh;
        }
        header {
            background: linear-gradient(135deg, #0052B1 0%, #0066CC 100%);
            color: white;
            padding: 20px;
            max-width: 800px;
            margin: 20px auto 10px auto;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 82, 177, 0.25);
        }
        .container {
            max-width: 800px;
            background: white;
            margin: 0 auto 30px auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        /* ===== SISTEMA DE PESTA√ëAS ===== */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin-bottom: 0;
            border-bottom: 2px solid #0052B1;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
            border-right: 1px solid #dee2e6;
        }
        .tab.active {
            background: #0052B1;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.4s ease;
            overflow: hidden !important;
        }
        .tab-content.active {
            display: block;
        }
        
        /* ===== BARRA DE PROGRESO ===== */
        .progress-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
            padding: 0 10px;
        }
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 10%;
            height: 4px;
            background: linear-gradient(90deg, #0052B1, #0066CC);
            z-index: 2;
            transition: width 0.5s ease;
            border-radius: 2px;
        }
        .progress-step {
            position: relative;
            z-index: 3;
            text-align: center;
            width: 40px;
            height: 40px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }
        .progress-step.active {
            background: linear-gradient(135deg, #0052B1, #0066CC);
            color: white;
            transform: scale(1.1);
        }
        .progress-label {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            color: #666;
        }
        
        /* ===== M√ìDULOS DEL FORMULARIO ===== */
        .module {
            display: none;
            padding-bottom: 10px;
        }
        .module.active {
            display: block;
            animation: slideUp 0.3s ease;
            position: relative;
        }
        .module-title {
            color: #0052B1;
            border-bottom: 3px solid #eaeaea;
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 1.4em;
        }
        
        /* ===== ESTILOS DE FORMULARIO ===== */
        label {
            display: block;
            margin-top: 18px;
            font-weight: 600;
            color: #444;
            font-size: 15px;
            clear: both;
        }
        input, select {
            width: 100%;
            padding: 14px;
            margin-top: 6px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s;
            background: #f9f9f9;
            display: block;
            clear: both;
        }
        input:focus, select:focus {
            border-color: #0052B1;
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 82, 177, 0.15);
        }
        
        /* Estilo espec√≠fico para campo num√©rico de edad */
        #edad {
            -moz-appearance: textfield;
        }
        #edad::-webkit-outer-spin-button,
        #edad::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .required {
            color: #e74c3c;
            font-weight: bold;
        }
        
        /* ===== BOTONES ===== */
        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #0052B1 0%, #0066CC 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 82, 177, 0.2);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 82, 177, 0.3);
        }
        button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
        }
        
        /* ===== CAMPOS CONDICIONALES ===== */
        .conditional-field {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #0052B1;
            animation: slideIn 0.3s ease;
        }
        
        /* ===== MAPA INTERACTIVO ===== */
        #mapa-css {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 2px solid #0052B1;
        }
        .comuna-css {
            position: absolute;
            background: rgba(0, 82, 177, 0.15);
            border: 2px solid #0052B1;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0052B1;
            font-weight: 600;
            font-size: 12px;
            overflow: hidden;
            box-sizing: border-box;
            z-index: 5;
            text-shadow: 0 0 2px white, 0 0 2px white;
        }
        .comuna-css:hover {
            background: rgba(0, 82, 177, 0.3);
            transform: scale(1.05);
            z-index: 10;
        }
        
        /* ===== TOOLTIP DEL MAPA ===== */
        .map-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
            min-width: 180px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
            backdrop-filter: blur(4px);
        }
        
        /* ===== TARJETAS DE ESTAD√çSTICAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            border-top: 4px solid #0052B1;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #0052B1;
            font-size: 1.1em;
        }
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }
        
        /* ===== TABLA DE ADMINISTRACI√ìN ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .data-table th {
            background: #0052B1;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        
        /* ===== MENSAJE DE √âXITO ===== */
        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: bold;
            border: 2px solid #c3e6cb;
            display: none;
        }
        .codigo-censo {
            font-size: 1.4em;
            color: #0052B1;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
            display: inline-block;
            font-family: monospace;
        }
        
        /* ===== BOTONES ESPECIALES ===== */
        .btn-export {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            margin: 10px 5px;
        }
        .btn-export:hover {
            background: linear-gradient(135deg, #218838 0%, #1e9e8a 100%) !important;
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            padding: 5px 10px !important;
            font-size: 12px !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #0052B1 0%, #0066CC 100%) !important;
            padding: 5px 10px !important;
            font-size: 12px !important;
            margin-right: 5px;
        }
        
        /* ===== RESPONSIVE PARA M√ìVILES ===== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            header {
                max-width: 100%;
                padding: 15px;
                margin: 10px auto;
                border-radius: 10px;
            }
            
            header h1 {
                font-size: 1.3em;
                margin: 10px 0;
            }
            
            header h2 {
                font-size: 1.1em;
            }
            
            header h3 {
                font-size: 1em;
            }
            
            .container {
                max-width: 100%;
                padding: 15px;
                margin: 0 auto 20px auto;
                border-radius: 10px;
            }
            
            /* Tabs en m√≥vil apilados verticalmente */
            .tabs {
                flex-direction: column;
                border-radius: 8px;
                margin-bottom: 15px;
            }
            
            .tab {
                padding: 12px;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
                text-align: left;
                font-size: 14px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            /* T√çTULOS DE M√ìDULOS - REDUCIDOS PARA M√ìVIL */
            .module-title {
                font-size: 1.1em !important;
                padding-bottom: 10px !important;
                margin-bottom: 20px !important;
                line-height: 1.3 !important;
                border-bottom: 2px solid #eaeaea !important;
            }
            
            /* M√≥dulos con mejor espaciado */
            .module {
                padding-top: 5px !important;
            }
            
            .module label {
                margin-top: 15px !important;
                margin-bottom: 5px !important;
                font-size: 14px !important;
            }
            
            .module input, 
            .module select {
                margin-top: 3px !important;
                margin-bottom: 8px !important;
            }
            
            /* Barra de progreso - ajustar para m√≥vil */
            .progress-container {
                margin-bottom: 15px !important;
                padding: 0 5px;
            }
            
            .progress-step {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .progress-label {
                font-size: 9px !important;
                top: 40px;
                white-space: nowrap;
                width: 45px !important;
                left: 50%;
                transform: translateX(-50%);
                line-height: 1.1 !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .progress-bar {
                top: 17px;
                left: 8% !important;
                width: 84% !important;
            }
            
            /* Layout de campos en fila (para c√©dula/edad) */
            .module > div[style*="display:flex"] {
                flex-direction: column !important;
                gap: 0 !important;
                margin-bottom: 5px !important;
            }
            
            .module > div[style*="display:flex"] > div {
                flex: 1 0 100% !important;
                margin-bottom: 15px !important;
            }
            
            /* Botones */
            button {
                padding: 12px 20px;
                font-size: 15px;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .actions {
                flex-direction: column !important;
                gap: 10px !important;
                margin-top: 20px !important;
                padding-top: 15px !important;
                border-top: 1px solid #eee !important;
            }
            
            .actions button {
                margin: 0 !important;
            }
            
            /* Mapa interactivo - reducir altura */
            #mapa-css {
                height: 350px;
                border-width: 1px;
            }
            
            /* Comunas del mapa - hacer m√°s legibles en m√≥vil */
            .comuna-css {
                font-size: 9px !important;
                font-weight: 600;
                padding: 2px;
                text-align: center;
                word-break: break-word;
                overflow-wrap: break-word;
                line-height: 1.2;
            }
            
            /* Ajustar posiciones de comunas para m√≥vil */
            .comuna-css[style*="Centro"] { top: 15% !important; left: 40% !important; width: 22% !important; height: 14% !important; }
            .comuna-css[style*="Calambeo"] { top: 10% !important; left: 65% !important; width: 25% !important; height: 12% !important; }
            .comuna-css[style*="San Sim√≥n"] { top: 28% !important; left: 60% !important; width: 26% !important; height: 14% !important; }
            .comuna-css[style*="Piedra Pintada"] { top: 42% !important; left: 35% !important; width: 32% !important; height: 14% !important; }
            .comuna-css[style*="Jord√°n"] { top: 30% !important; left: 10% !important; width: 28% !important; height: 17% !important; }
            .comuna-css[style*="Vergel"] { top: 52% !important; left: 5% !important; width: 32% !important; height: 15% !important; }
            .comuna-css[style*="Salado"] { top: 68% !important; left: 20% !important; width: 28% !important; height: 13% !important; }
            .comuna-css[style*="Sim√≥n Bol√≠var"] { top: 62% !important; left: 45% !important; width: 22% !important; height: 14% !important; }
            .comuna-css[style*="Picale√±a Mirolindo"] { top: 42% !important; left: 70% !important; width: 30% !important; height: 14% !important; }
            .comuna-css[style*="Estadio"] { top: 5% !important; left: 30% !important; width: 22% !important; height: 11% !important; }
            .comuna-css[style*="Ferias"] { top: 0% !important; left: 55% !important; width: 20% !important; height: 11% !important; }
            .comuna-css[style*="Las Brisas"] { top: 72% !important; left: 0% !important; width: 28% !important; height: 14% !important; }
            .comuna-css[style*="Boquer√≥n"] { top: 58% !important; left: 70% !important; width: 28% !important; height: 16% !important; }
            
            /* Tooltip del mapa - ajustar para m√≥vil */
            .map-tooltip {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 80% !important;
                max-width: 300px;
                z-index: 9999;
            }
            
            /* Grid de estad√≠sticas - 2 columnas */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
                min-height: 80px;
            }
            
            .stat-card h3 {
                font-size: 13px;
                margin-bottom: 8px;
            }
            
            .stat-card .number {
                font-size: 1.8em;
            }
            
            /* Botones especiales en mapa y admin */
            .btn-export, button[style*="min-width:200px"] {
                min-width: 100% !important;
                margin: 5px 0 !important;
            }
            
            /* Tabla de administraci√≥n - hacer scrollable */
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 8px;
                font-size: 13px;
            }
            
            /* Checkbox de aceptaci√≥n */
            .checkbox-container {
                padding: 15px !important;
                flex-direction: row !important;
                align-items: center !important;
            }
            
            .checkbox-container input {
                width: 20px !important;
                height: 20px;
                margin-right: 10px;
                margin-bottom: 0;
                transform: scale(1.2);
            }
            
            .checkbox-container label {
                margin-top: 0;
                font-size: 13px;
                line-height: 1.4;
            }
            
            /* Mensaje de √©xito */
            .success-message {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .codigo-censo {
                font-size: 1.2em;
                padding: 8px;
                word-break: break-all;
            }
            
            /* Barra de b√∫squeda */
            #searchInput {
                padding: 12px;
                font-size: 15px;
            }
            
            /* Contador de registros */
            #contadorRegistros {
                font-size: 14px;
            }
            
            /* Campos condicionales */
            .conditional-field {
                margin-top: 15px !important;
                padding: 12px !important;
            }
        }
        
        /* ===== PANTALLAS MUY PEQUE√ëAS (Menos de 480px) ===== */
        @media (max-width: 480px) {
            /* T√≠tulos a√∫n m√°s peque√±os */
            .module-title {
                font-size: 1em !important;
                padding-bottom: 8px !important;
                margin-bottom: 15px !important;
            }
            
            /* Mejor espacio entre elementos */
            .module > * {
                margin-bottom: 8px !important;
            }
            
            .module label {
                margin-bottom: 4px !important;
            }
            
            .module input, 
            .module select {
                margin-bottom: 12px !important;
            }
            
            /* Progreso a√∫n m√°s compacto */
            .progress-container {
                justify-content: space-around;
            }
            
            .progress-step {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            
            .progress-label {
                font-size: 8px;
                top: 35px;
                width: 40px;
            }
            
            .progress-bar {
                top: 15px;
            }
            
            /* Estad√≠sticas - 1 columna */
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            /* Mapa a√∫n m√°s peque√±o */
            #mapa-css {
                height: 300px;
            }
            
            .comuna-css {
                font-size: 8px !important;
                line-height: 1.1;
            }
            
            /* Tabla - ajustar columnas */
            .data-table td:nth-child(1),
            .data-table th:nth-child(1) {
                min-width: 80px;
            }
            
            /* Botones de acci√≥n en tabla */
            .btn-primary, .btn-danger {
                padding: 6px 10px !important;
                font-size: 11px !important;
                margin-bottom: 5px !important;
                display: block;
                width: 100%;
            }
            
            /* Textos generales */
            body {
                font-size: 14px;
            }
        }
        
        /* ===== ORIENTACI√ìN HORIZONTAL EN M√ìVILES ===== */
        @media (max-width: 768px) and (orientation: landscape) {
            #mapa-css {
                height: 250px;
            }
            
            .tabs {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 30%;
                font-size: 12px;
                padding: 10px 5px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* ANIMACIONES */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <header>
        <h3>O.N.G. Colectivo Social Nacional</h3>
        <h2>Observatorio Social - Sistema de Censo Territorial</h2>
        <h1>Plataforma Integral de Gesti√≥n Social</h1>
    </header>

    <div class="container">
        <!-- SISTEMA DE PESTA√ëAS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('censo')">üìã Nuevo Censo</button>
            <button class="tab" onclick="switchTab('mapa')">üó∫Ô∏è Mapa Interactivo</button>
            <button class="tab" onclick="switchTab('admin')">üìä Administraci√≥n</button>
        </div>

        <!-- PESTA√ëA 1: FORMULARIO DE CENSO -->
        <div id="censo-tab" class="tab-content active">
            <!-- BARRA DE PROGRESO -->
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-step active" data-step="1">1<div class="progress-label">Datos Personales</div></div>
                <div class="progress-step" data-step="2">2<div class="progress-label">Contacto</div></div>
                <div class="progress-step" data-step="3">3<div class="progress-label">Actividad</div></div>
                <div class="progress-step" data-step="4">4<div class="progress-label">Ubicaci√≥n</div></div>
                <div class="progress-step" data-step="5">5<div class="progress-label">Legal</div></div>
            </div>

            <!-- M√ìDULO 1: DATOS PERSONALES -->
            <div class="module active" id="m1">
                <h2 class="module-title">M√≥dulo 1 ‚Äì Datos Personales</h2>
                
                <label>Nombre completo <span class="required">*</span></label>
                <input id="nombre" placeholder="Ingrese su nombre completo">
                
                <div style="display:flex; gap:20px; margin:10px 0;">
                    <div style="flex:1;">
                        <label>C√©dula <span class="required">*</span></label>
                        <input id="cedula" placeholder="Ej: 1234567890" type="text">
                    </div>
                    <div style="flex:1;">
                        <label>Edad <span class="required">*</span></label>
                        <input type="number" id="edad" min="1" max="120" placeholder="Ej: 25">
                    </div>
                </div>
                
                <label>G√©nero <span class="required">*</span></label>
                <select id="genero">
                    <option value="">Seleccione</option>
                    <option value="masculino">Masculino</option>
                    <option value="femenino">Femenino</option>
                    <option value="otro">Otro</option>
                </select>
                
                <!-- CAMPO CONDICIONAL: MADRE CABEZA DE HOGAR -->
                <div class="conditional-field" id="madreCabezaField">
                    <label>¬øEs madre cabeza de hogar? <span class="required">*</span></label>
                    <select id="madreCabeza">
                        <option value="">Seleccione</option>
                        <option value="si">S√≠</option>
                        <option value="no">No</option>
                    </select>
                </div>
                
                <div class="actions" style="margin-top:30px; display:flex; justify-content:flex-end;">
                    <button onclick="nextModule(1)">Siguiente</button>
                </div>
            </div>

            <!-- M√ìDULO 2: CONTACTO -->
            <div class="module" id="m2">
                <h2 class="module-title">M√≥dulo 2 ‚Äì Contacto</h2>
                
                <label>Tel√©fono <span class="required">*</span></label>
                <input id="telefono" placeholder="Ej: 3001234567">
                
                <label>Direcci√≥n de vivienda</label>
                <input id="direccion" placeholder="Calle, carrera, n√∫mero">
                
                <label>Casa propia <span class="required">*</span></label>
                <select id="casa">
                    <option value="">Seleccione</option>
                    <option value="si">S√≠</option>
                    <option value="no">No</option>
                </select>
                
                <!-- CAMPO CONDICIONAL: TIPO DE VIVIENDA SI NO ES PROPIA -->
                <div class="conditional-field" id="tipoViviendaField">
                    <label>Si no es propia, especifique <span class="required">*</span></label>
                    <select id="tipoVivienda">
                        <option value="">Seleccione</option>
                        <option value="familiar">Vive con familiares</option>
                        <option value="arriendo">Arriendo</option>
                        <option value="prestada">Vivienda prestada</option>
                        <option value="invitado">Invitado</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                
                <div class="actions" style="margin-top:30px; display:flex; justify-content:space-between;">
                    <button class="secondary" onclick="prevModule(2)">Anterior</button>
                    <button onclick="nextModule(2)">Siguiente</button>
                </div>
            </div>

            <!-- M√ìDULO 3: ACTIVIDAD -->
            <div class="module" id="m3">
                <h2 class="module-title">M√≥dulo 3 ‚Äì Actividad</h2>
                
                <label>Tipo de trabajo <span class="required">*</span></label>
                <select id="trabajo">
                    <option value="">Seleccione</option>
                    <option value="formal">Formal</option>
                    <option value="informal">Informal</option>
                    <option value="desempleado">Desempleado</option>
                    <option value="estudiante">Estudiante</option>
                    <option value="pensionado">Pensionado</option>
                </select>
                
                <!-- CAMPO CONDICIONAL: SUBCATEGOR√çA DE TRABAJO INFORMAL -->
                <div class="conditional-field" id="subcategoriaTrabajoField">
                    <label>Subcategor√≠a de trabajo informal <span class="required">*</span></label>
                    <select id="subcategoriaTrabajo">
                        <option value="">Seleccione</option>
                        <option value="vendedor">Vendedor informal</option>
                        <option value="turnos">Trabajo por turnos</option>
                        <option value="horas">Trabajo por horas</option>
                        <option value="independiente">Independiente</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                
                <label>Detalle de la ocupaci√≥n</label>
                <input id="detalle" placeholder="Ej: Reciclador, comerciante ambulante, etc.">
                
                <div class="actions" style="margin-top:30px; display:flex; justify-content:space-between;">
                    <button class="secondary" onclick="prevModule(3)">Anterior</button>
                    <button onclick="nextModule(3)">Siguiente</button>
                </div>
            </div>

            <!-- M√ìDULO 4: UBICACI√ìN -->
            <div class="module" id="m4">
                <h2 class="module-title">M√≥dulo 4 ‚Äì Ubicaci√≥n</h2>
                
                <label>Comuna <span class="required">*</span></label>
                <select id="comuna" onchange="cargarBarrios()">
                    <option value="">Seleccione una comuna</option>
                </select>
                
                <label>Barrio <span class="required">*</span></label>
                <select id="barrio">
                    <option value="">Primero seleccione una comuna</option>
                </select>
                
                <div class="actions" style="margin-top:30px; display:flex; justify-content:space-between;">
                    <button class="secondary" onclick="prevModule(4)">Anterior</button>
                    <button onclick="nextModule(4)">Siguiente</button>
                </div>
            </div>

            <!-- M√ìDULO 5: LEGAL -->
            <div class="module" id="m5">
                <h2 class="module-title">M√≥dulo 5 ‚Äì Legal</h2>
                
                <label>¬øHa sido vulnerado en sus derechos?</label>
                <select id="derechos">
                    <option value="">Seleccione</option>
                    <option value="decomiso">Decomiso</option>
                    <option value="maltrato">Maltrato</option>
                    <option value="desplazamiento">Desplazamiento</option>
                    <option value="ninguno">Ninguno</option>
                </select>
                
                <label>Relaci√≥n con instituci√≥n</label>
                <select id="relacionInstitucion">
                    <option value="">Seleccione</option>
                    <option value="ninguna">Ninguna</option>
                    <option value="policia">Polic√≠a</option>
                    <option value="funcionario_alcaldia">Funcionario de alcald√≠a</option>
                    <option value="miembro_comercio">Miembro del comercio</option>
                    <option value="otros">Otros</option>
                </select>
                
                <div class="checkbox-container" style="display:flex; align-items:center; margin-top:25px; padding:18px; background:#f8f9fa; border-radius:8px;">
                    <input type="checkbox" id="acepto" style="width:auto; margin-right:15px;">
                    <label for="acepto" style="margin-top:0; font-weight:500;">Acepto el tratamiento de datos conforme a la Ley 1581 de 2012 <span class="required">*</span></label>
                </div>
                
                <div class="actions" style="margin-top:30px; display:flex; justify-content:space-between;">
                    <button class="secondary" onclick="prevModule(5)">Anterior</button>
                    <button onclick="finalizarRegistro()">Finalizar registro</button>
                </div>
            </div>
            
            <!-- MENSAJE DE √âXITO -->
            <div class="success-message" id="successMessage">
                <h3>¬°Registro completado exitosamente!</h3>
                <p>Su c√≥digo de censo es:</p>
                <div class="codigo-censo" id="codigoCenso"></div>
                <p>Guarde este c√≥digo para futuras referencias.</p>
            </div>
        </div>

        <!-- PESTA√ëA 2: MAPA INTERACTIVO -->
        <div id="mapa-tab" class="tab-content">
            <h2 class="module-title">üó∫Ô∏è Mapa Interactivo Territorial</h2>
            
            <!-- CONTENEDOR DEL MAPA -->
            <div id="mapa-css"></div>
            
            <!-- TOOLTIP DEL MAPA -->
            <div class="map-tooltip" id="mapTooltip"></div>
            
            <!-- ESTAD√çSTICAS DEL MAPA -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Comuna Seleccionada</h3>
                    <div class="number" id="comunaSeleccionada">-</div>
                </div>
                <div class="stat-card">
                    <h3>Barrios en Comuna</h3>
                    <div class="number" id="barriosComuna">0</div>
                </div>
                <div class="stat-card">
                    <h3>Registros en Comuna</h3>
                    <div class="number" id="registrosComuna">0</div>
                </div>
                <div class="stat-card">
                    <h3>Densidad (reg/barrio)</h3>
                    <div class="number" id="densidadComuna">-</div>
                </div>
            </div>
            
            <!-- BOTONES DE ACCI√ìN -->
            <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="generarReporteComuna()" style="padding:12px 24px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; flex:1; min-width:200px;">
                    üìã Generar Reporte de Comuna
                </button>
                <button onclick="verDetalleComuna()" class="secondary" style="flex:1; min-width:200px;">
                    üîç Ver Detalle Completo
                </button>
            </div>
        </div>

        <!-- PESTA√ëA 3: ADMINISTRACI√ìN -->
        <div id="admin-tab" class="tab-content">
            <h2 class="module-title">üìä Panel de Administraci√≥n</h2>
            
            <!-- ESTAD√çSTICAS PRINCIPALES -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Registros</h3>
                    <div class="number" id="totalRegistros">0</div>
                </div>
                <div class="stat-card">
                    <h3>Registros Hoy</h3>
                    <div class="number" id="registrosHoy">0</div>
                </div>
                <div class="stat-card">
                    <h3>Mujeres Registradas</h3>
                    <div class="number" id="mujeresRegistradas">0</div>
                </div>
                <div class="stat-card">
                    <h3>Trabajo Informal</h3>
                    <div class="number" id="trabajoInformal">0</div>
                </div>
            </div>
            
            <!-- BOTONES DE EXPORTACI√ìN -->
            <div style="margin:20px 0; display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="exportarAExcel()" class="btn-export" style="flex:1; min-width:200px;">
                    üìä Exportar a Excel (Todos los registros)
                </button>
                <button onclick="exportarFiltradosExcel()" class="btn-export" style="flex:1; min-width:200px;">
                    üìã Exportar Resultados Filtrados
                </button>
            </div>
            
            <!-- BARRA DE B√öSQUEDA -->
            <div style="margin:20px 0;">
                <input type="text" id="searchInput" placeholder="üîç Buscar por c√©dula, nombre o c√≥digo..." 
                       style="width:100%; padding:15px; border:2px solid #dee2e6; border-radius:8px; font-size:16px;">
            </div>
            
            <!-- TABLA DE REGISTROS -->
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>C√©dula</th>
                            <th>Comuna</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                            <th>Eliminar</th>
                        </tr>
                    </thead>
                    <tbody id="registrosBody">
                        <!-- Los registros se cargan din√°micamente -->
                    </tbody>
                </table>
            </div>
            
            <!-- CONTADOR DE REGISTROS -->
            <div style="text-align:center; margin:20px 0; color:#666;">
                <p id="contadorRegistros">Mostrando 0 registros</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN Y DATOS DEL SISTEMA
        // ============================================
        
        // Base de datos en memoria (se guarda en localStorage)
        let database = {
            registros: JSON.parse(localStorage.getItem('censoRegistros')) || [],
            estadisticas: JSON.parse(localStorage.getItem('censoEstadisticas')) || {
                total: 0, hoy: 0, mujeres: 0, informales: 0,
                porComuna: {}, porGenero: { masculino: 0, femenino: 0, otro: 0 }
            }
        };
        
        // ============================================
        // CORRECCI√ìN CR√çTICA: NORMALIZAR NOMBRES DE COMUNAS
        // ============================================
        
        // LISTA UNIFICADA DE COMUNAS - NOMBRES EXACTOS
        const comunasUnificadas = {
            "Centro": "Centro",
            "Calambeo": "Calambeo", 
            "San Sim√≥n": "San Sim√≥n",
            "Piedra Pintada": "Piedra Pintada",
            "Jord√°n": "Jord√°n",
            "Vergel": "Vergel",
            "Salado": "Salado",
            "Sim√≥n Bol√≠var": "Sim√≥n Bol√≠var",
            "Picale√±a Mirolindo": "Picale√±a Mirolindo",
            "Estadio": "Estadio",
            "Ferias": "Ferias",
            "Las Brisas": "Las Brisas",
            "Boquer√≥n": "Boquer√≥n"
        };
        
        // Datos de barrios por comuna (usando nombres unificados)
        const barriosPorComuna = {
            "Centro": ["Augusto E Medina", "Baltazar", "Centro", "Combeima", "Estacion", "Interlaken", "La Pola", "Libertador", "Pola parte alta", "Pueblo nuevo", "San pedro Alejandrino"],
            "Calambeo": ["20 de Julio", "7 de Agosto", "Alaska", "Ancon", "Bel√©n", "Belencito", "Centenario", "Centro pan de Az√∫car", "Clarita Botero", "La Aurora", "La Paz", "La Sof√≠a", "La Trinidad", "Malavar", "Para√≠so", "San Diego", "Santa Barbara", "Santa Cruz", "VI Brigada", "Vi√±a de Clambeo", "Villa Adriana"],
            "San Sim√≥n": ["Antonio Nari√±o", "Belalc√°zar", "Calambeo", "Carmenza Rocha", "El Carmen", "Fenalco", "Gait√°n parte alta", "INEM", "La esperanza", "La Granja", "La Acacias", "San sim√≥n parte alta", "Villa llusi√≥n", "Villa Pinz√≥n", "Villa Valentina", "Viveros"],
            "Piedra Pintada": ["Alfonso L√≥pez", "Calarc√°", "Cambulos", "Caracol√≠", "Castilla", "Gait√°n", "Jacaranda", "Jes√∫s Mar√≠a C√≥rdoba", "Jos√© mar√≠a c√≥rdoba pate baja", "Limonar", "Limonar V sector", "Onzaga", "Piedra pintada", "Pijao", "Restrepo", "Rinc√≥n de piedra pintada", "San Carlos", "San Luis", "Sorrento", "Toscana", "Triunfo", "Villa Marlen I", "Villa Marlen II", "Villa Teresa"],
            "Jord√°n": ["4 Etapa del Jord√°n", "6 Etapa del Jord√°n", "7 Etapa del Jord√°n", "8 Etapa del Jord√°n", "9 Etapa del Jord√°n", "Andalicia", "Arboleda margaritas", "Arkacentro", "Arkamonica", "Arrayanes", "Calatayud", "Conj Res La Alemania", "Cordobita", "El Ed√©n", "La campi√±a", "La Ladera", "Las Margaritas", "Las orqu√≠deas", "Macadamia", "Multifamiliares el Jord√°n", "Multifamiliares Las Margaritas", "Prados del Norte", "Rinc√≥n de la Campi√±a", "San jacinto", "Torre Ladera", "Urb Aymara I", "Urb Aymara II", "Rincon de las Margaritas", "Urb Los Ocobos", "Urb Milenio I y II", "Urb Yacaira", "Urb Parrales"],
            "Vergel": ["Agua viva", "Altos de san francisco", "Balcones del vergel", "Bosques del vergel", "Brisas de Pedregal", "Ca√±averal I", "Ca√±averal II", "Camino de juan pablo II", "camino de san Francisco", "Camino del Vergel", "Cond√≥mino Ronda del Vergel", "Cond√≥mino tierra alta", "Conjunto cerrado Ambala", "Conjunto cerrado los Balsos", "El Mirador", "El Triunfo", "Estancia del vergel", "Fuente de Los Rosales", "Fuente de Los Rosales II", "La balsa", "La Esperanza", "La Gaviota", "Las Delicias", "Loa Alpes", "Loa √Ångeles", "Los ciruelos", "Los Mandarinos", "Monte Madero", "Monte verde del Vergel", "Palma del Vergel", "Paseo de san Francisco", "Plazas del Bosque", "Portal del Vergel", "Primavera de Entre Rio", "Reservas del Pedregal", "Rinc√≥n de San Francisco", "Rinc√≥n del Pedregal I", "Rinc√≥n del Pedregal II", "Rinc√≥n del Vergel", "San Antonio", "Tierra linda del Vergel", "Torre fuente de los Rosales", "Torres de la Calleja", "Urb Arkala I", "Urb Arkambuco I", "Colinas del Norte", "Urb Pedregal", "Urb Villa Patricia", "Urb Altos de Ambala", "Urb Altos del pedregal", "Urb Ambala", "Urb Antares I", "Urb Antares II", "Urb Arkala II", "Urb Chicala", "Urb Entre R√≠os I", "Urb Entre R√≠os II", "Urb Fuente de los Rosales I", "Urb Girasol", "Urb Ibagu√© 2000", "Urb Los Cambulos", "Urb Los Gualandayes", "Urb Villa Vanesa", "Villa Gloria"],
            "Salado": ["Alamos", "chico", "El Salado", "Hacienda el Recreo", "Los Musicos", "Mirador de Cantabria", "Modelia I", "Modelia II", "Nueva Bilbao", "Pedro Ignacio VillaMarin", "Rosales de Tailandia", "Santa Ana", "Sector los Alpes", "Timaka", "Urb Santa Coloma", "Urb Alameda", "Urb Carlos LLeras C", "Urb Ambikaima", "Urb Cantabria", "Urb Comfatolima", "Urb Diana Milaidy", "Urb El Dorado", "Urb El Lim√≥n", "Urb El Palmar", "Fuente del Salado", "Urb Fuente santa", "Urb La Caba√±a", "Urb La Candelar", "Urb La Floresta", "Urb La victoria", "Urb Lady Diana", "Urb Los Lagos", "Urb Monte Carlos", "Urb Oviedo", "Urb Pacand√©", "Urb Palma del Rio", "Urb Palo Grande", "Urb Portales del Norte", "Urb Praderas del Norte", "Urb Reservas de Cantabria", "Urb San Luis", "Urb San Luis Gonzaga", "Urb San Luis II", "Urb San Pablo", "Urb San Sebasti√°n", "Urb Santa catalina I", "Urb Santa M√≥nica", "Urb Shaddai", "Urb Territorio de Paz", "Urb Villa Brasilia", "Urb Villa clara II", "Urb Villa Julieta", "Protecho", "Urb Quinta Avenida", "Urb Tolima Grande", "Urb Vasconia", "Urb Vasconia Reservado", "Urb Villa del Norte", "Urb Villa del Palmar", "Urb Villa del Sol", "Urb Villa esperanza", "Urb Villa Jard√≠n", "Urb Villa la paz", "Urb Villa Magdalena", "Urb Villa Marcela", "Urb Villa Vicentina", "Cristales", "Yerbabuena"],
            "Sim√≥n Bol√≠var": ["Atolsure", "Caminos del Bosque", "Ciudadela Sim√≥n Bol√≠var I", "Ciudadela Sim√≥n Bol√≠var II", "Ciudadela Sim√≥n Bol√≠var III", "Conj Recid San Joaqu√≠n", "El Bunde I ,II y III", "Urb El bunde IV", "German Huertas", "Jard√≠n I", "Jard√≠n III", "Jard√≠n parte baja", "Jard√≠n Santander I, II y III", "Jard√≠n Valpara√≠so", "La Cima I", "La Cima II", "Musicaria", "palermo", "portal del Jard√≠n", "Reservas del Jard√≠n", "Roberto Augusto Calder√≥n", "San Gelato", "Topacio", "Tulio Var√≥n", "Unidad Resid Carabineros", "Urb 2 de Julio", "Urb Agua Marina", "Urb Altos de Vasconia", "Urb Antonio Mar√≠a", "Urb Brisas de Vasconia", "Urb Buenaventura Garc√≠a", "Urb Ciudad Blanca", "Urb El Palmar I", "Urb El Palmar II", "Urb El Prado I", "Urb El Prado II", "Urb Jard√≠n Antolsure", "Urb Jard√≠n Avenida V", "Urb Jard√≠n Chipalo I", "Urb Jard√≠n Chipalo II", "Urb Jard√≠n II", "Urb Jard√≠n Porvenir", "Urb Jard√≠n VI", "Urb Jardines del Campo", "Urb La Esmeralda", "Urb Las Acacias", "Urb Los Comuneros", "Urb Los Laureles", "Urb Los Pinos", "Urb Nueva Castilla", "Urb Nueva Colombia", "Urb Nuevo Armero", "Urb Nuevo Combeima", "Urb Nuevo Combeima II", "Urb Portal de Arkal√°", "Versalles"],
            "Picale√±a Mirolindo": ["Etapa II del Jord√°n", "Alfonso Uribe Badillo", "Altamira", "Aparco", "arboleda", "Arkaniza I", "Arkaniza II", "Arkapara√≠so", "Bello Horizonte", "Bosque de la Alameda", "Carrenales", "Cond Las Palmeras", "Conj Resid Valpara√≠so", "El Tunal", "hacienda piedra pintada", "Jord√°n 3 Etapa", "Jord√°n 1 Etapa", "La Floresta", "Los Tunjos", "Picale√±ita", "Picale√±a", "portal de los Tunjos", "Reservas del Campestre", "San Francisco", "san remo", "Urb Bosque de Varsovia", "Urb Chaquen", "Urb Ciudad Luz", "Urb Comfenalco", "Urb Coopdiasam", "Urb Cutucumay", "Urb El poblado", "Urb Las Am√©ricas", "Urb Las flores", "Urb Los Remansos", "Urb Miraflores", "Urb nuevo horizonte", "Urb portal campestre", "Urb Praderas de santa Rita", "Urb Tahit√≠", "Urb Varsovia", "Urb Villa Arkadia", "Urb Villa caf√©", "Urb Villa de la Candelaria", "Urb Villa luz", "Urb Villa Yuli", "Valpara√≠so I", "Valpara√≠so II", "Valpara√≠so III", "Valpara√≠so IV", "Villa Carvajalita", "Villa del Pilar", "Villa Mar√≠a", "Villa Natalia"],
            "Estadio": ["Arkalena", "Bosques de santa Helena", "Boyac√°", "C√°diz", "Casa Club", "Castellana", "Claret", "Departamental", "Federico Lleras", "Hip√≥dromo", "La Francia", "Las palmas", "Laureles", "Macarena parte Alta", "Macarena", "Macarena parte Baja", "Magisterio", "Metaima parte Alta", "Metaima parte Baja", "monte alegre", "Nacional", "Naciones Unidas", "San Cayetano", "Santa Helena", "Santander"],
            "Ferias": ["12 de Octubre", "Alto de la Cruz", "Am√©rica", "Arado", "Bosque Parte Alta", "Bosque parte baja", "refugio I", "refugio II", "Garz√≥n", "Independiente", "La Isla", "La Martinica", "Las Brisas", "Las Ferias", "Libertad", "Los M√°rtires", "Pe√±√≥n", "Popular", "Rodr√≠guez Andrade", "san Vicente de Pa√∫l", "Uribe Uribe", "Villa del r√≠o", "Villa Mar√≠a"],
            "Las Brisas": ["Andr√©s L√≥pez de Galarza", "Avenida", "Colonias de Asprovi", "Gal√°n", "Industrial", "Kennedy", "La Gaitana", "La pradera", "La Reforma", "Las Vegas", "Matallana", "Murillo Toro", "Ricaurte", "Rosa Badillo", "Santofimio", "Urb Arkaima", "Urb Divino Ni√±o", "Urb terrazas del Tejar", "Venecia", "Villa Claudia", "Villa Luces", "Yuldaima"],
            "Boquer√≥n": ["Albania", "Boquer√≥n", "Cerro Granate", "Colinas I", "Colinas II", "Dar√≠o Echand√≠a", "Granada", "Isla", "Jazm√≠n", "La Uni√≥n", "Miramar", "San Isidro", "terrazas de Boquer√≥n", "Villa Mery"]
        };
        
        // Lista de comunas para el select
        const listaComunas = Object.keys(comunasUnificadas);
        
        // ============================================
        // FUNCI√ìN PARA NORMALIZAR NOMBRES DE COMUNAS
        // ============================================
        
        function normalizarNombreComuna(nombre) {
            if (!nombre || typeof nombre !== 'string') return '';
            
            // Primero, eliminar espacios extras y normalizar
            let nombreLimpio = nombre.trim();
            
            // Buscar coincidencias exactas primero
            for (const comunaUnificada in comunasUnificadas) {
                if (nombreLimpio === comunaUnificada) {
                    return comunasUnificadas[comunaUnificada];
                }
            }
            
            // Buscar coincidencias aproximadas
            for (const comunaUnificada in comunasUnificadas) {
                const comunaNormalizada = comunaUnificada.toLowerCase().replace(/\s+/g, '');
                const nombreLimpioNormalizado = nombreLimpio.toLowerCase().replace(/\s+/g, '');
                
                // Si hay una coincidencia cercana, retornar el nombre unificado
                if (comunaNormalizada.includes(nombreLimpioNormalizado) || 
                    nombreLimpioNormalizado.includes(comunaNormalizada)) {
                    return comunasUnificadas[comunaUnificada];
                }
            }
            
            // Si no encuentra coincidencia, devolver el nombre original
            return nombreLimpio;
        }
        
        // ============================================
        // FUNCIONES DEL SISTEMA (PESTA√ëAS)
        // ============================================
        
        // Cambiar entre pesta√±as
        function switchTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tabBtn => tabBtn.classList.remove('active'));
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Ejecutar acciones espec√≠ficas por pesta√±a
            if (tabName === 'admin') actualizarPanelAdmin();
            if (tabName === 'mapa') inicializarMapaCSS();
        }
        
        // ============================================
        // FUNCIONES DEL FORMULARIO DE CENSO
        // ============================================
        
        // Inicializar select de comunas en el formulario
        function inicializarComunasSelect() {
            const comunaSelect = document.getElementById('comuna');
            comunaSelect.innerHTML = '<option value="">Seleccione una comuna</option>';
            listaComunas.forEach((comuna, index) => {
                const option = document.createElement('option');
                option.value = comunasUnificadas[comuna]; // Usar nombre unificado
                option.textContent = `${index + 1}. ${comunasUnificadas[comuna]}`;
                comunaSelect.appendChild(option);
            });
        }
        
        // Cargar barrios seg√∫n comuna seleccionada
        function cargarBarrios() {
            const barrioSelect = document.getElementById('barrio');
            const comunaNombre = document.getElementById('comuna').value;
            barrioSelect.innerHTML = '<option value="">Seleccione un barrio</option>';
            
            if (comunaNombre && barriosPorComuna[comunaNombre]) {
                // Ordenar barrios alfab√©ticamente
                barriosPorComuna[comunaNombre]
                    .sort((a, b) => a.localeCompare(b, 'es', {sensitivity: 'base'}))
                    .forEach(barrio => {
                        const option = document.createElement('option');
                        option.value = barrio;
                        option.textContent = barrio;
                        barrioSelect.appendChild(option);
                    });
                barrioSelect.disabled = false;
            } else {
                barrioSelect.disabled = true;
                barrioSelect.innerHTML = '<option value="">Primero seleccione una comuna</option>';
            }
        }
        
        // ============================================
        // FUNCIONES PARA AJUSTAR BARRA DE PROGRESO EN M√ìVILES
        // ============================================
        
        function ajustarBarraProgresoParaMovil() {
            if (window.innerWidth <= 768) {
                const progressSteps = document.querySelectorAll('.progress-step');
                const progressBar = document.getElementById('progressBar');
                
                // Ajustar posiciones para m√≥vil
                progressSteps.forEach((step, index) => {
                    const label = step.querySelector('.progress-label');
                    if (label) {
                        // Asegurar que las etiquetas no se superpongan
                        label.style.whiteSpace = 'nowrap';
                        label.style.width = 'auto';
                        label.style.maxWidth = '50px';
                        label.style.overflow = 'hidden';
                        label.style.textOverflow = 'ellipsis';
                    }
                });
                
                // Ajustar ancho de la barra
                if (progressBar) {
                    progressBar.style.left = '8%';
                    progressBar.style.width = '84%';
                }
            }
        }
        
        // ============================================
        // FUNCI√ìN PARA REDIMENSIONAR DIN√ÅMICAMENTE
        // ============================================
        
        function handleResize() {
            ajustarBarraProgresoParaMovil();
            
            // Si estamos en el mapa, reiniciarlo para ajustar posiciones
            if (document.getElementById('mapa-tab').classList.contains('active')) {
                inicializarMapaCSS();
            }
        }
        
        // ============================================
        // NAVEGACI√ìN ENTRE M√ìDULOS DEL FORMULARIO
        // ============================================
        
        let currentModule = 1;
        
        function showModule(n) {
            currentModule = n;
            
            // Ocultar todos los m√≥dulos con transici√≥n suave
            document.querySelectorAll('.module').forEach(m => {
                m.style.display = 'none';
                m.style.opacity = '0';
                m.style.transform = 'translateY(10px)';
            });
            
            // Mostrar m√≥dulo actual con animaci√≥n
            const currentModuleElement = document.getElementById(`m${n}`);
            setTimeout(() => {
                currentModuleElement.style.display = 'block';
                setTimeout(() => {
                    currentModuleElement.style.opacity = '1';
                    currentModuleElement.style.transform = 'translateY(0)';
                }, 10);
            }, 50);
            
            // Actualizar barra de progreso
            const progressSteps = document.querySelectorAll('.progress-step');
            const progressBar = document.getElementById('progressBar');
            const width = ((n - 1) / 4) * 90;
            progressBar.style.width = `${width}%`;
            
            progressSteps.forEach(step => {
                const stepNum = parseInt(step.getAttribute('data-step'));
                if (stepNum <= n) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // Ajustar para m√≥vil si es necesario
            ajustarBarraProgresoParaMovil();
            
            // Hacer scroll suave al inicio del m√≥dulo en m√≥viles
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    currentModuleElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
            }
        }
        
        function nextModule(n) {
            // Validaciones b√°sicas por m√≥dulo
            let isValid = true;
            let errorMessage = '';
            
            if (n === 1) {
                if (!document.getElementById('nombre').value.trim()) {
                    isValid = false;
                    errorMessage = 'Nombre completo es obligatorio';
                }
                if (!document.getElementById('cedula').value.trim()) {
                    isValid = false;
                    errorMessage = 'C√©dula es obligatoria';
                }
                if (!document.getElementById('edad').value || document.getElementById('edad').value < 1) {
                    isValid = false;
                    errorMessage = 'Edad es obligatoria (m√≠nimo 1 a√±o)';
                }
                if (!document.getElementById('genero').value) {
                    isValid = false;
                    errorMessage = 'G√©nero es obligatorio';
                }
                // Validar madre cabeza de hogar si es femenino
                if (document.getElementById('genero').value === 'femenino' && 
                    !document.getElementById('madreCabeza').value) {
                    isValid = false;
                    errorMessage = 'Para g√©nero femenino, debe indicar si es madre cabeza de hogar';
                }
            }
            
            if (n === 2 && !document.getElementById('telefono').value.trim()) {
                isValid = false;
                errorMessage = 'Tel√©fono es obligatorio';
            }
            
            if (n === 4 && (!document.getElementById('comuna').value || !document.getElementById('barrio').value)) {
                isValid = false;
                errorMessage = 'Debe seleccionar una comuna y un barrio';
            }
            
            if (isValid) {
                showModule(n + 1);
            } else {
                alert(`‚ùå Por favor complete los campos obligatorios:\n\n${errorMessage}`);
            }
        }
        
        function prevModule(n) {
            showModule(n - 1);
        }
        
        // Finalizar registro
        let consecutivo = JSON.parse(localStorage.getItem('censoConsecutivo')) || 1;
        
        function finalizarRegistro() {
            // Validar aceptaci√≥n de tratamiento de datos
            if (!document.getElementById('acepto').checked) {
                alert('Debe aceptar el tratamiento de datos para continuar.');
                return;
            }
            
            // Obtener comuna seleccionada y NORMALIZARLA
            const comunaSelect = document.getElementById('comuna');
            const comunaNombre = comunaSelect.value;
            
            // Si no est√° en la lista unificada, normalizarla
            let comunaNormalizada = comunaNombre;
            if (comunaNombre && !comunasUnificadas[comunaNombre]) {
                comunaNormalizada = normalizarNombreComuna(comunaNombre);
            }
            
            // Recoger datos del formulario
            const registro = {
                id: Date.now(),
                codigoCenso: `CEN-${document.getElementById('cedula').value.substring(0,4)}-${String(consecutivo).padStart(4,'0')}`,
                nombre: document.getElementById('nombre').value,
                cedula: document.getElementById('cedula').value,
                edad: document.getElementById('edad').value,
                genero: document.getElementById('genero').options[document.getElementById('genero').selectedIndex].text,
                madreCabeza: document.getElementById('genero').value === 'femenino' ? 
                    document.getElementById('madreCabeza').options[document.getElementById('madreCabeza').selectedIndex].text : '',
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value || 'No especificada',
                casaPropia: document.getElementById('casa').options[document.getElementById('casa').selectedIndex].text,
                tipoVivienda: document.getElementById('casa').value === 'no' ? 
                    document.getElementById('tipoVivienda').options[document.getElementById('tipoVivienda').selectedIndex].text : '',
                trabajo: document.getElementById('trabajo').options[document.getElementById('trabajo').selectedIndex].text,
                subcategoriaTrabajo: document.getElementById('trabajo').value === 'informal' ? 
                    document.getElementById('subcategoriaTrabajo').options[document.getElementById('subcategoriaTrabajo').selectedIndex].text : '',
                detalleTrabajo: document.getElementById('detalle').value || 'No especificado',
                comuna: comunaNormalizada, // <-- NOMBRE NORMALIZADO
                barrio: document.getElementById('barrio').value,
                derechos: document.getElementById('derechos').options[document.getElementById('derechos').selectedIndex].text,
                relacionInstitucion: document.getElementById('relacionInstitucion').options[document.getElementById('relacionInstitucion').selectedIndex].text,
                fecha: new Date().toISOString(),
                fechaFormateada: new Date().toLocaleDateString('es-CO', {
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                })
            };
            
            // Guardar en base de datos
            database.registros.push(registro);
            consecutivo++;
            
            // Actualizar estad√≠sticas
            actualizarEstadisticas(registro);
            
            // Guardar en localStorage
            guardarEnStorage();
            
            // Mostrar confirmaci√≥n
            document.getElementById('codigoCenso').textContent = registro.codigoCenso;
            document.getElementById('successMessage').style.display = 'block';
            
            // Reiniciar formulario despu√©s de 5 segundos
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
                
                // Limpiar todos los campos del formulario
                document.querySelectorAll('#censo-tab input, #censo-tab select').forEach(el => {
                    if (el.type !== 'button' && el.id !== 'acepto') {
                        el.value = '';
                    }
                });
                
                document.getElementById('acepto').checked = false;
                document.getElementById('barrio').innerHTML = '<option value="">Primero seleccione una comuna</option>';
                document.getElementById('barrio').disabled = true;
                
                // Ocultar campos condicionales
                document.getElementById('madreCabezaField').style.display = 'none';
                document.getElementById('tipoViviendaField').style.display = 'none';
                document.getElementById('subcategoriaTrabajoField').style.display = 'none';
                
                // Volver al m√≥dulo 1
                showModule(1);
                
                // Si estamos en admin, actualizar
                if (document.getElementById('admin-tab').classList.contains('active')) {
                    actualizarPanelAdmin();
                }
            }, 5000);
        }
        
        function actualizarEstadisticas(registro) {
            // Actualizar contadores generales
            database.estadisticas.total++;
            
            // Verificar si es de hoy
            const hoy = new Date().toDateString();
            const fechaRegistro = new Date(registro.fecha).toDateString();
            if (fechaRegistro === hoy) database.estadisticas.hoy++;
            
            // Por g√©nero
            if (registro.genero === 'Femenino') {
                database.estadisticas.mujeres++;
                database.estadisticas.porGenero.femenino++;
            } else if (registro.genero === 'Masculino') {
                database.estadisticas.porGenero.masculino++;
            } else {
                database.estadisticas.porGenero.otro++;
            }
            
            // Por trabajo
            if (registro.trabajo === 'Informal') {
                database.estadisticas.informales++;
            }
            
            // Por comuna (usando nombre normalizado)
            if (registro.comuna) {
                const comunaKey = normalizarNombreComuna(registro.comuna);
                if (!database.estadisticas.porComuna[comunaKey]) {
                    database.estadisticas.porComuna[comunaKey] = 0;
                }
                database.estadisticas.porComuna[comunaKey]++;
            }
        }
        
        function guardarEnStorage() {
            localStorage.setItem('censoRegistros', JSON.stringify(database.registros));
            localStorage.setItem('censoEstadisticas', JSON.stringify(database.estadisticas));
            localStorage.setItem('censoConsecutivo', consecutivo);
        }
        
        // ============================================
        // MAPA INTERACTIVO (MAPA 1 - CSS) - CORREGIDO PARA M√ìVIL
        // ============================================
        
        function inicializarMapaCSS() {
            const contenedor = document.getElementById('mapa-css');
            contenedor.innerHTML = '';
            
            // Detectar si es m√≥vil
            const esMovil = window.innerWidth <= 768;
            
            // Definir posiciones diferentes para m√≥vil y desktop
            const comunasMapa = esMovil ? [
                // Posiciones optimizadas para m√≥vil (m√°s grandes, menos superposici√≥n)
                { nombre: "Centro", top: "15%", left: "40%", width: "22%", height: "14%", color: "#0052B1" },
                { nombre: "Calambeo", top: "10%", left: "65%", width: "25%", height: "12%", color: "#0066CC" },
                { nombre: "San Sim√≥n", top: "28%", left: "60%", width: "26%", height: "14%", color: "#007BFF" },
                { nombre: "Piedra Pintada", top: "42%", left: "35%", width: "32%", height: "14%", color: "#0052B1" },
                { nombre: "Jord√°n", top: "30%", left: "10%", width: "28%", height: "17%", color: "#0066CC" },
                { nombre: "Vergel", top: "52%", left: "5%", width: "32%", height: "15%", color: "#007BFF" },
                { nombre: "Salado", top: "68%", left: "20%", width: "28%", height: "13%", color: "#0052B1" },
                { nombre: "Sim√≥n Bol√≠var", top: "62%", left: "45%", width: "22%", height: "14%", color: "#0066CC" },
                { nombre: "Picale√±a Mirolindo", top: "42%", left: "70%", width: "30%", height: "14%", color: "#007BFF" },
                { nombre: "Estadio", top: "5%", left: "30%", width: "22%", height: "11%", color: "#0052B1" },
                { nombre: "Ferias", top: "0%", left: "55%", width: "20%", height: "11%", color: "#0066CC" },
                { nombre: "Las Brisas", top: "72%", left: "0%", width: "28%", height: "14%", color: "#007BFF" },
                { nombre: "Boquer√≥n", top: "58%", left: "70%", width: "28%", height: "16%", color: "#0052B1" }
            ] : [
                // Posiciones originales para desktop
                { nombre: "Centro", top: "30%", left: "45%", width: "12%", height: "15%", color: "#0052B1" },
                { nombre: "Calambeo", top: "25%", left: "60%", width: "15%", height: "12%", color: "#0066CC" },
                { nombre: "San Sim√≥n", top: "40%", left: "55%", width: "14%", height: "13%", color: "#007BFF" },
                { nombre: "Piedra Pintada", top: "50%", left: "40%", width: "16%", height: "14%", color: "#0052B1" },
                { nombre: "Jord√°n", top: "35%", left: "25%", width: "13%", height: "16%", color: "#0066CC" },
                { nombre: "Vergel", top: "55%", left: "20%", width: "15%", height: "15%", color: "#007BFF" },
                { nombre: "Salado", top: "70%", left: "30%", width: "14%", height: "12%", color: "#0052B1" },
                { nombre: "Sim√≥n Bol√≠var", top: "65%", left: "50%", width: "12%", height: "14%", color: "#0066CC" },
                { nombre: "Picale√±a Mirolindo", top: "45%", left: "70%", width: "16%", height: "13%", color: "#007BFF" },
                { nombre: "Estadio", top: "20%", left: "35%", width: "11%", height: "10%", color: "#0052B1" },
                { nombre: "Ferias", top: "15%", left: "50%", width: "10%", height: "11%", color: "#0066CC" },
                { nombre: "Las Brisas", top: "75%", left: "10%", width: "14%", height: "13%", color: "#007BFF" },
                { nombre: "Boquer√≥n", top: "60%", left: "75%", width: "13%", height: "15%", color: "#0052B1" }
            ];
            
            comunasMapa.forEach(comuna => {
                const div = document.createElement('div');
                div.className = 'comuna-css';
                div.textContent = comuna.nombre;
                div.style.top = comuna.top;
                div.style.left = comuna.left;
                div.style.width = comuna.width;
                div.style.height = comuna.height;
                div.style.background = `linear-gradient(135deg, ${comuna.color}20, ${comuna.color}40)`;
                div.style.borderColor = comuna.color;
                div.style.color = comuna.color;
                
                // Eventos para tooltip y selecci√≥n
                div.addEventListener('mouseenter', (e) => mostrarTooltipMapa(e, comuna.nombre));
                div.addEventListener('mouseleave', ocultarTooltipMapa);
                div.addEventListener('click', () => seleccionarComunaMapa(comuna.nombre));
                
                contenedor.appendChild(div);
            });
        }
        
        // Mostrar tooltip sobre una comuna en el mapa
        function mostrarTooltipMapa(event, nombreComuna) {
            const tooltip = document.getElementById('mapTooltip');
            
            // Normalizar el nombre de la comuna del mapa
            const comunaMapaNormalizada = normalizarNombreComuna(nombreComuna);
            
            // Buscar registros usando nombres normalizados
            const registros = database.registros.filter(r => {
                if (!r.comuna) return false;
                const comunaRegistroNormalizada = normalizarNombreComuna(r.comuna);
                return comunaRegistroNormalizada === comunaMapaNormalizada;
            }).length;
            
            const barrios = barriosPorComuna[comunaMapaNormalizada]?.length || 0;
            const densidad = barrios > 0 ? (registros / barrios).toFixed(2) : "0.00";
            
            tooltip.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px; color:#0052B1;">${comunaMapaNormalizada}</div>
                <div>üèòÔ∏è <strong>Barrios:</strong> ${barrios}</div>
                <div>üìã <strong>Registros:</strong> ${registros}</div>
                <div>üìà <strong>Densidad:</strong> ${densidad} reg/barrio</div>
                <div style="font-size:11px; margin-top:5px; color:#888;">Click para seleccionar</div>
            `;
            
            // En m√≥vil, centrar el tooltip
            if (window.innerWidth <= 768) {
                tooltip.style.position = 'fixed';
                tooltip.style.top = '50%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
                tooltip.style.width = '80%';
                tooltip.style.maxWidth = '300px';
            } else {
                tooltip.style.left = (event.clientX + 15) + 'px';
                tooltip.style.top = (event.clientY - 15) + 'px';
                tooltip.style.position = 'absolute';
                tooltip.style.transform = 'none';
                tooltip.style.width = 'auto';
            }
            
            tooltip.style.display = 'block';
            
            // Resaltar visualmente la comuna
            document.querySelectorAll('.comuna-css').forEach(el => {
                if (el.textContent === nombreComuna) {
                    el.style.boxShadow = '0 0 15px rgba(0, 82, 177, 0.7)';
                }
            });
        }
        
        // Ocultar tooltip del mapa
        function ocultarTooltipMapa() {
            const tooltip = document.getElementById('mapTooltip');
            tooltip.style.display = 'none';
            
            // Quitar resaltado de todas las comunas
            document.querySelectorAll('.comuna-css').forEach(el => {
                el.style.boxShadow = 'none';
            });
        }
        
        // Seleccionar una comuna en el mapa
        function seleccionarComunaMapa(nombreComuna) {
            // Normalizar el nombre de la comuna del mapa
            const comunaMapaNormalizada = normalizarNombreComuna(nombreComuna);
            
            // Buscar registros usando nombres normalizados
            const registrosComuna = database.registros.filter(r => {
                if (!r.comuna) return false;
                const comunaRegistroNormalizada = normalizarNombreComuna(r.comuna);
                return comunaRegistroNormalizada === comunaMapaNormalizada;
            });
            
            // Actualizar los indicadores
            document.getElementById('comunaSeleccionada').textContent = comunaMapaNormalizada;
            document.getElementById('barriosComuna').textContent = barriosPorComuna[comunaMapaNormalizada]?.length || 0;
            document.getElementById('registrosComuna').textContent = registrosComuna.length;
            
            const densidad = barriosPorComuna[comunaMapaNormalizada]?.length > 0 ? 
                (registrosComuna.length / barriosPorComuna[comunaMapaNormalizada].length).toFixed(2) : "0.00";
            document.getElementById('densidadComuna').textContent = densidad;
        }
        
        // Generar reporte de comuna seleccionada
        function generarReporteComuna() {
            const comuna = document.getElementById('comunaSeleccionada').textContent;
            if (comuna === '-') {
                alert('Por favor selecciona una comuna en el mapa primero.');
                return;
            }
            
            // Normalizar el nombre de la comuna
            const comunaNormalizada = normalizarNombreComuna(comuna);
            
            // Buscar registros usando nombres normalizados
            const registros = database.registros.filter(r => {
                if (!r.comuna) return false;
                const comunaRegistroNormalizada = normalizarNombreComuna(r.comuna);
                return comunaRegistroNormalizada === comunaNormalizada;
            });
            
            if (registros.length === 0) {
                alert(`No hay registros en la comuna ${comunaNormalizada}.`);
                return;
            }
            
            let reporte = `üìä REPORTE DE LA COMUNA: ${comunaNormalizada}\n\n`;
            reporte += `üìÖ Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-CO')}\n`;
            reporte += `üìã Total de registros: ${registros.length}\n`;
            reporte += `üèòÔ∏è Barrios en la comuna: ${barriosPorComuna[comunaNormalizada]?.length || 0}\n\n`;
            
            // Estad√≠sticas b√°sicas
            const hombres = registros.filter(r => r.genero === 'Masculino').length;
            const mujeres = registros.filter(r => r.genero === 'Femenino').length;
            const informales = registros.filter(r => r.trabajo === 'Informal').length;
            
            reporte += `üë• ESTAD√çSTICAS DEMOGR√ÅFICAS:\n`;
            reporte += `‚Ä¢ Hombres: ${hombres} (${((hombres/registros.length)*100).toFixed(1)}%)\n`;
            reporte += `‚Ä¢ Mujeres: ${mujeres} (${((mujeres/registros.length)*100).toFixed(1)}%)\n`;
            reporte += `‚Ä¢ Madres cabeza de hogar: ${registros.filter(r => r.madreCabeza === 'S√≠').length}\n\n`;
            
            reporte += `üíº ESTAD√çSTICAS LABORALES:\n`;
            reporte += `‚Ä¢ Trabajo informal: ${informales} (${((informales/registros.length)*100).toFixed(1)}%)\n`;
            reporte += `‚Ä¢ Trabajo formal: ${registros.filter(r => r.trabajo === 'Formal').length}\n`;
            reporte += `‚Ä¢ Desempleados: ${registros.filter(r => r.trabajo === 'Desempleado').length}\n\n`;
            
            reporte += `üè† VIVIENDA:\n`;
            reporte += `‚Ä¢ Casa propia: ${registros.filter(r => r.casaPropia === 'S√≠').length}\n`;
            reporte += `‚Ä¢ En arriendo: ${registros.filter(r => r.tipoVivienda === 'arriendo').length}\n`;
            
            // Agregar lista de barrios con registros
            reporte += `\nüìã REGISTROS POR BARRIO:\n`;
            const barriosConRegistros = {};
            registros.forEach(r => {
                const barrio = r.barrio || 'Sin barrio especificado';
                if (!barriosConRegistros[barrio]) {
                    barriosConRegistros[barrio] = 0;
                }
                barriosConRegistros[barrio]++;
            });
            
            Object.entries(barriosConRegistros).forEach(([barrio, count]) => {
                reporte += `‚Ä¢ ${barrio}: ${count} registro(s)\n`;
            });
            
            alert(reporte);
        }
        
        // Ver detalle completo de la comuna (ir a administraci√≥n)
        function verDetalleComuna() {
            const comuna = document.getElementById('comunaSeleccionada').textContent;
            if (comuna === '-') {
                alert('Por favor selecciona una comuna en el mapa primero.');
                return;
            }
            
            // Normalizar el nombre de la comuna
            const comunaNormalizada = normalizarNombreComuna(comuna);
            
            // Cambiar a pesta√±a de admin y filtrar
            switchTab('admin');
            document.getElementById('searchInput').value = comunaNormalizada;
            buscarRegistros();
        }
        
        // ============================================
        // PANEL DE ADMINISTRACI√ìN
        // ============================================
        
        function actualizarPanelAdmin() {
            // Actualizar estad√≠sticas principales
            document.getElementById('totalRegistros').textContent = database.estadisticas.total;
            document.getElementById('registrosHoy').textContent = database.estadisticas.hoy;
            document.getElementById('mujeresRegistradas').textContent = database.estadisticas.mujeres;
            document.getElementById('trabajoInformal').textContent = database.estadisticas.informales;
            
            // Actualizar tabla de registros
            const tbody = document.getElementById('registrosBody');
            tbody.innerHTML = '';
            
            if (database.registros.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding:20px; text-align:center; color:#666;">
                            No hay registros a√∫n. Comienza capturando datos en la pesta√±a "Nuevo Censo".
                        </td>
                    </tr>
                `;
                document.getElementById('contadorRegistros').textContent = 'Mostrando 0 registros';
                return;
            }
            
            // Mostrar √∫ltimos 15 registros
            const ultimosRegistros = [...database.registros].reverse().slice(0, 15);
            
            ultimosRegistros.forEach(registro => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${registro.codigoCenso}</td>
                    <td>${registro.nombre}</td>
                    <td>${registro.cedula}</td>
                    <td>${registro.comuna}</td>
                    <td>${new Date(registro.fecha).toLocaleDateString()}</td>
                    <td>
                        <button onclick="verDetalleRegistro(${registro.id})" class="btn-primary">
                            üëÅÔ∏è Ver
                        </button>
                    </td>
                    <td>
                        <button onclick="eliminarRegistroDirecto(${registro.id})" class="btn-danger">
                            üóëÔ∏è Eliminar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('contadorRegistros').textContent = 
                `Mostrando ${ultimosRegistros.length} de ${database.registros.length} registros`;
        }
        
        function buscarRegistros() {
            const busqueda = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('registrosBody');
            tbody.innerHTML = '';
            
            const resultados = database.registros.filter(registro => 
                registro.codigoCenso.toLowerCase().includes(busqueda) ||
                registro.nombre.toLowerCase().includes(busqueda) ||
                registro.cedula.toLowerCase().includes(busqueda) ||
                normalizarNombreComuna(registro.comuna).toLowerCase().includes(busqueda)
            ).reverse();
            
            if (resultados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding:20px; text-align:center; color:#666;">
                            No se encontraron registros con esos criterios.
                        </td>
                    </tr>
                `;
                document.getElementById('contadorRegistros').textContent = 'Encontrados 0 registros';
                return;
            }
            
            resultados.forEach(registro => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${registro.codigoCenso}</td>
                    <td>${registro.nombre}</td>
                    <td>${registro.cedula}</td>
                    <td>${registro.comuna}</td>
                    <td>${new Date(registro.fecha).toLocaleDateString()}</td>
                    <td>
                        <button onclick="verDetalleRegistro(${registro.id})" class="btn-primary">
                            üëÅÔ∏è Ver
                        </button>
                    </td>
                    <td>
                        <button onclick="eliminarRegistroDirecto(${registro.id})" class="btn-danger">
                            üóëÔ∏è Eliminar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('contadorRegistros').textContent = `Encontrados ${resultados.length} registros`;
        }
        
        // ============================================
        // FUNCIONES DE ELIMINACI√ìN DE REGISTROS
        // ============================================
        
        // FUNCI√ìN verDetalleRegistro ACTUALIZADA
        function verDetalleRegistro(id) {
            const registro = database.registros.find(r => r.id === id);
            if (!registro) return;
            
            let detalles = `üìÑ DETALLE COMPLETO DEL REGISTRO\n\n`;
            detalles += `üìã C√≥digo: ${registro.codigoCenso}\n`;
            detalles += `üë§ Nombre: ${registro.nombre}\n`;
            detalles += `üÜî C√©dula: ${registro.cedula}\n`;
            detalles += `üéÇ Edad: ${registro.edad}\n`;
            detalles += `‚ößÔ∏è G√©nero: ${registro.genero}\n`;
            if (registro.madreCabeza) detalles += `üë©‚Äçüëß‚Äçüë¶ Madre cabeza de hogar: ${registro.madreCabeza}\n`;
            detalles += `üìû Tel√©fono: ${registro.telefono}\n`;
            detalles += `üè† Direcci√≥n: ${registro.direccion}\n`;
            detalles += `üè° Casa propia: ${registro.casaPropia}\n`;
            if (registro.tipoVivienda) detalles += `üèöÔ∏è Tipo de vivienda: ${registro.tipoVivienda}\n`;
            detalles += `üíº Trabajo: ${registro.trabajo}\n`;
            if (registro.subcategoriaTrabajo) detalles += `üìä Subcategor√≠a: ${registro.subcategoriaTrabajo}\n`;
            detalles += `üìù Detalle: ${registro.detalleTrabajo}\n`;
            detalles += `üó∫Ô∏è Comuna: ${registro.comuna}\n`;
            detalles += `üèòÔ∏è Barrio: ${registro.barrio}\n`;
            detalles += `‚öñÔ∏è Derechos vulnerados: ${registro.derechos}\n`;
            detalles += `üèõÔ∏è Relaci√≥n con instituci√≥n: ${registro.relacionInstitucion}\n`;
            detalles += `üìÖ Fecha de registro: ${registro.fechaFormateada}\n\n`;
            detalles += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            detalles += `¬øQu√© desea hacer con este registro?\n`;
            
            // Usar confirm con opciones personalizadas
            const opcion = confirm(detalles + "\nClick en ACEPTAR para volver a la lista, CANCELAR para permanecer aqu√≠.");
            
            if (opcion) {
                // Si hace clic en Aceptar, simplemente volver (no hacer nada m√°s)
                console.log('Volviendo a la lista de registros...');
            } else {
                // Si hace clic en Cancelar, mostrar opci√≥n para eliminar
                const eliminar = confirm('¬øDesea ELIMINAR este registro?\n\nClick en ACEPTAR para eliminar, CANCELAR para conservarlo.');
                if (eliminar) {
                    eliminarRegistroDirecto(id);
                }
            }
        }
        
        // NUEVA FUNCI√ìN: Eliminar registro directamente desde la tabla
        function eliminarRegistroDirecto(id) {
            const registro = database.registros.find(r => r.id === id);
            if (!registro) return;
            
            if (confirm(`‚ö†Ô∏è ¬øEst√° seguro de eliminar el registro?\n\nC√≥digo: ${registro.codigoCenso}\nNombre: ${registro.nombre}\nC√©dula: ${registro.cedula}\n\nEsta acci√≥n no se puede deshacer.`)) {
                const index = database.registros.findIndex(r => r.id === id);
                if (index !== -1) {
                    // Eliminar el registro
                    database.registros.splice(index, 1);
                    
                    // Recalcular estad√≠sticas
                    recalcularEstadisticas();
                    
                    // Guardar cambios
                    guardarEnStorage();
                    
                    // Actualizar panel
                    actualizarPanelAdmin();
                    
                    alert('‚úÖ Registro eliminado correctamente.');
                }
            }
        }
        
        // FUNCI√ìN PARA RECALCULAR ESTAD√çSTICAS:
        function recalcularEstadisticas() {
            // Reiniciar estad√≠sticas
            database.estadisticas = {
                total: 0, hoy: 0, mujeres: 0, informales: 0,
                porComuna: {}, porGenero: { masculino: 0, femenino: 0, otro: 0 }
            };
            
            // Recalcular todo desde cero
            database.registros.forEach(registro => {
                database.estadisticas.total++;
                
                const hoy = new Date().toDateString();
                const fechaRegistro = new Date(registro.fecha).toDateString();
                if (fechaRegistro === hoy) database.estadisticas.hoy++;
                
                if (registro.genero === 'Femenino') {
                    database.estadisticas.mujeres++;
                    database.estadisticas.porGenero.femenino++;
                } else if (registro.genero === 'Masculino') {
                    database.estadisticas.porGenero.masculino++;
                } else {
                    database.estadisticas.porGenero.otro++;
                }
                
                if (registro.trabajo === 'Informal') {
                    database.estadisticas.informales++;
                }
                
                if (registro.comuna) {
                    const comunaKey = normalizarNombreComuna(registro.comuna);
                    if (!database.estadisticas.porComuna[comunaKey]) {
                        database.estadisticas.porComuna[comunaKey] = 0;
                    }
                    database.estadisticas.porComuna[comunaKey]++;
                }
            });
        }
        
        // ============================================
        // FUNCI√ìN DE EXPORTACI√ìN A EXCEL
        // ============================================
        
        // Funci√≥n para exportar TODOS los registros a Excel con formato de tabla
        function exportarAExcel() {
            if (database.registros.length === 0) {
                alert('No hay registros para exportar.');
                return;
            }
            
            // Crear el contenido CSV con separadores correctos
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM para Excel
            
            // Encabezados con separador punto y coma (mejor para Excel)
            const headers = [
                "C√≥digo Censo",
                "Nombre Completo",
                "C√©dula",
                "Edad",
                "G√©nero",
                "Madre Cabeza Hogar",
                "Tel√©fono",
                "Direcci√≥n",
                "Casa Propia",
                "Tipo Vivienda",
                "Trabajo",
                "Subcategor√≠a Trabajo",
                "Detalle Trabajo",
                "Comuna",
                "Barrio",
                "Derechos Vulnerados",
                "Relaci√≥n Instituci√≥n",
                "Fecha Registro"
            ];
            
            csvContent += headers.join(";") + "\r\n";
            
            // Agregar cada registro con formato correcto
            database.registros.forEach(registro => {
                const row = [
                    registro.codigoCenso || "",
                    registro.nombre || "",
                    registro.cedula || "",
                    registro.edad || "",
                    registro.genero || "",
                    registro.madreCabeza || "",
                    registro.telefono || "",
                    registro.direccion || "",
                    registro.casaPropia || "",
                    registro.tipoVivienda || "",
                    registro.trabajo || "",
                    registro.subcategoriaTrabajo || "",
                    registro.detalleTrabajo || "",
                    registro.comuna || "",
                    registro.barrio || "",
                    registro.derechos || "",
                    registro.relacionInstitucion || "",
                    registro.fechaFormateada || ""
                ];
                
                // Escapar comillas y puntos y comas dentro de los datos
                const escapedRow = row.map(cell => {
                    // Convertir a string y escapar caracteres especiales
                    const cellStr = String(cell);
                    if (cellStr.includes(';') || cellStr.includes('"') || cellStr.includes('\n') || cellStr.includes('\r')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                });
                
                csvContent += escapedRow.join(";") + "\r\n";
            });
            
            // Crear enlace de descarga
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            
            // Nombre del archivo con fecha
            const fecha = new Date().toISOString().slice(0,10);
            link.setAttribute("download", `Censo_Territorial_${fecha}.csv`);
            document.body.appendChild(link);
            
            // Descargar el archivo
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Se exportaron ${database.registros.length} registros a Excel.\n\nEl archivo se descargar√° autom√°ticamente.\n\nüìå IMPORTANTE: Al abrir en Excel, selecciona "Datos" ‚Üí "Desde texto/CSV" y especifica el separador como "punto y coma (;)"`);
        }
        
        // Funci√≥n para exportar resultados filtrados a Excel
        function exportarFiltradosExcel() {
            const busqueda = document.getElementById('searchInput').value.toLowerCase();
            
            let registrosAExportar;
            
            if (busqueda.trim() === '') {
                // Si no hay b√∫squeda, exportar todos
                registrosAExportar = database.registros;
            } else {
                // Filtrar seg√∫n la b√∫squeda actual
                registrosAExportar = database.registros.filter(registro => 
                    registro.codigoCenso.toLowerCase().includes(busqueda) ||
                    registro.nombre.toLowerCase().includes(busqueda) ||
                    registro.cedula.toLowerCase().includes(busqueda) ||
                    normalizarNombreComuna(registro.comuna).toLowerCase().includes(busqueda)
                );
            }
            
            if (registrosAExportar.length === 0) {
                alert('No hay registros para exportar.');
                return;
            }
            
            // Crear el contenido CSV con separadores correctos
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM para Excel
            
            // Encabezados con separador punto y coma
            const headers = [
                "C√≥digo Censo",
                "Nombre Completo",
                "C√©dula",
                "Edad",
                "G√©nero",
                "Madre Cabeza Hogar",
                "Tel√©fono",
                "Direcci√≥n",
                "Casa Propia",
                "Tipo Vivienda",
                "Trabajo",
                "Subcategor√≠a Trabajo",
                "Detalle Trabajo",
                "Comuna",
                "Barrio",
                "Derechos Vulnerados",
                "Relaci√≥n Instituci√≥n",
                "Fecha Registro"
            ];
            
            csvContent += headers.join(";") + "\r\n";
            
            // Agregar cada registro con formato correcto
            registrosAExportar.forEach(registro => {
                const row = [
                    registro.codigoCenso || "",
                    registro.nombre || "",
                    registro.cedula || "",
                    registro.edad || "",
                    registro.genero || "",
                    registro.madreCabeza || "",
                    registro.telefono || "",
                    registro.direccion || "",
                    registro.casaPropia || "",
                    registro.tipoVivienda || "",
                    registro.trabajo || "",
                    registro.subcategoriaTrabajo || "",
                    registro.detalleTrabajo || "",
                    registro.comuna || "",
                    registro.barrio || "",
                    registro.derechos || "",
                    registro.relacionInstitucion || "",
                    registro.fechaFormateada || ""
                ];
                
                // Escapar comillas y puntos y comas dentro de los datos
                const escapedRow = row.map(cell => {
                    const cellStr = String(cell);
                    if (cellStr.includes(';') || cellStr.includes('"') || cellStr.includes('\n') || cellStr.includes('\r')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                });
                
                csvContent += escapedRow.join(";") + "\r\n";
            });
            
            // Nombre del archivo con filtro
            let nombreArchivo = `Censo_Territorial_${new Date().toISOString().slice(0,10)}`;
            if (busqueda.trim() !== '') {
                nombreArchivo += `_Filtro_${busqueda.substring(0, 20).replace(/[^a-z0-9]/gi, '_')}`;
            }
            
            // Crear enlace de descarga
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${nombreArchivo}.csv`);
            document.body.appendChild(link);
            
            // Descargar el archivo
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Se exportaron ${registrosAExportar.length} registros a Excel.\n\nEl archivo se descargar√° autom√°ticamente.\n\nüìå IMPORTANTE: Al abrir en Excel, selecciona "Datos" ‚Üí "Desde texto/CSV" y especifica el separador como "punto y coma (;)"`);
        }
        
        // ============================================
        // INICIALIZACI√ìN DEL SISTEMA
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar formulario
            inicializarComunasSelect();
            showModule(1);
            
            // Configurar eventos condicionales del formulario
            document.getElementById('genero').addEventListener('change', function() {
                document.getElementById('madreCabezaField').style.display = 
                    this.value === 'femenino' ? 'block' : 'none';
            });
            
            document.getElementById('casa').addEventListener('change', function() {
                document.getElementById('tipoViviendaField').style.display = 
                    this.value === 'no' ? 'block' : 'none';
            });
            
            document.getElementById('trabajo').addEventListener('change', function() {
                document.getElementById('subcategoriaTrabajoField').style.display = 
                    this.value === 'informal' ? 'block' : 'none';
            });
            
            // Configurar b√∫squeda en tiempo real
            document.getElementById('searchInput').addEventListener('input', buscarRegistros);
            
            // Configurar redimensionamiento de ventana
            window.addEventListener('resize', handleResize);
            
            // Ajustar barra de progreso inicialmente
            ajustarBarraProgresoParaMovil();
            
            // Cargar consecutivo desde localStorage
            const ultimoRegistro = database.registros[database.registros.length - 1];
            if (ultimoRegistro && ultimoRegistro.codigoCenso) {
                const match = ultimoRegistro.codigoCenso.match(/CEN-\d{4}-(\d+)/);
                if (match) consecutivo = parseInt(match[1]) + 1;
            }
            
            // SOLO CREAR DATOS DE PRUEBA SI NO HAY NING√öN REGISTRO
            if (database.registros.length === 0 && localStorage.getItem('datosPruebaCreados') !== 'true') {
                console.log('üîß Creando datos de prueba iniciales...');
                
                const fechaBase = new Date();
                for (let i = 1; i <= 5; i++) {
                    const registroPrueba = {
                        id: Date.now() + i,
                        codigoCenso: `CEN-TEST-${i.toString().padStart(4,'0')}`,
                        nombre: `Persona Prueba ${i}`,
                        cedula: `1000000${i}`,
                        edad: 25 + i,
                        genero: i % 2 === 0 ? 'Femenino' : 'Masculino',
                        madreCabeza: i % 2 === 0 ? 'S√≠' : '',
                        telefono: `300123456${i}`,
                        direccion: `Calle Prueba ${i}, Ciudad`,
                        casaPropia: i % 3 === 0 ? 'S√≠' : 'No',
                        tipoVivienda: i % 3 === 0 ? '' : 'arriendo',
                        trabajo: i % 2 === 0 ? 'Formal' : 'Informal',
                        subcategoriaTrabajo: i % 2 === 0 ? '' : 'vendedor',
                        detalleTrabajo: 'Ocupaci√≥n de prueba para el sistema',
                        comuna: 'Picale√±a Mirolindo',
                        barrio: barriosPorComuna['Picale√±a Mirolindo'][i % barriosPorComuna['Picale√±a Mirolindo'].length],
                        derechos: 'ninguno',
                        relacionInstitucion: 'ninguna',
                        fecha: new Date(fechaBase.getTime() - i * 86400000).toISOString(),
                        fechaFormateada: new Date(fechaBase.getTime() - i * 86400000).toLocaleDateString('es-CO')
                    };
                    
                    database.registros.push(registroPrueba);
                    actualizarEstadisticas(registroPrueba);
                }
                
                // Marcar que ya se crearon los datos de prueba
                localStorage.setItem('datosPruebaCreados', 'true');
                
                // Guardar datos de prueba
                guardarEnStorage();
                console.log(`‚úÖ 5 registros de prueba creados (solo una vez)`);
            }
            
            console.log('‚úÖ Sistema de Censo Territorial inicializado.');
            console.log(`üìä Registros totales: ${database.registros.length}`);
            console.log(`üì± Modo responsive activado`);
            
            // Actualizar panel de administraci√≥n
            actualizarPanelAdmin();
        });
    </script>
</body>
</html>